<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>5 YEARS: SURVIVAL ANNIVERSARY MODE</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070A16;
      --bg1:#0B1230;
      --text:#F4F7FF;
      --muted:#B7C2E6;
      --aqua:#46FFD2;
      --pink:#FF4D6D;
      --amber:#FFD166;
      --stroke: rgba(255,255,255,.16);
      --shadow: rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1000px 600px at 50% 25%, #1A2A66 0%, var(--bg1) 40%, var(--bg0) 100%);
      overflow:hidden;
      min-height: 100dvh;
    }

    #app{position:fixed; inset:0; height:100dvh;}
    #sceneWrap{
      position:relative; width:100%; height:100%;
      touch-action:none;
    }
    svg{width:100%; height:100%; display:block;}

    .ui{
      position:absolute; inset:0;
      pointer-events:auto;
      display:flex; flex-direction:column;
    }

    .topbar{
      display:flex; gap:10px; align-items:center;
      padding:12px;
      pointer-events:none;
      opacity:0;
      transform:translateY(-8px);
      transition:.2s ease;
    }
    body.state-chase .topbar{opacity:1; transform:none;}

    .pill{
      pointer-events:none;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow: 0 14px 40px var(--shadow);
      backdrop-filter: blur(10px);
      font-weight:800;
      font-size:13px;
      display:flex; align-items:center; gap:8px;
    }
    .pill small{font-weight:700; color:var(--muted)}

    .toast{
      position:absolute; left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      width:min(920px, 92vw);
      padding:12px 14px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(18,26,52,.55), rgba(10,14,28,.55));
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      pointer-events:none;
      opacity:0;
      transition:.18s ease;
      font-weight:900;
      font-size:13px;
      text-align:center;
    }
    .toast.show{opacity:1}

    .titleCard{
      position:absolute;
      left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      width:min(980px, 92vw);
      padding:16px 16px 14px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(18,26,52,.62), rgba(10,14,28,.62));
      box-shadow: 0 24px 80px rgba(0,0,0,.40);
      backdrop-filter: blur(12px);
      pointer-events:auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    body.state-title .titleCard{display:flex}
    body:not(.state-title) .titleCard{display:none}

    .titleCard .left{display:flex; flex-direction:column; gap:6px; min-width:0;}
    .titleCard .left .hint{
      font-weight:750;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .btnRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    button{
      font: inherit;
      cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(70,255,210,.18), rgba(70,255,210,.06));
      color:var(--text);
      font-weight:900;
      box-shadow: 0 16px 40px rgba(0,0,0,.30);
      transition: transform .08s ease, filter .08s ease;
      pointer-events:auto;
      touch-action: manipulation;
    }
    button:hover{filter:brightness(1.07)}
    button:active{transform:translateY(2px)}
    .secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--muted);
      font-weight:850;
    }

    .controls{
      position:absolute;
      left:0; right:0;
      bottom: calc(88px + env(safe-area-inset-bottom));
      padding:0 14px;
      display:flex; justify-content:space-between; align-items:flex-end;
      pointer-events:auto;
      opacity:0; transform:translateY(8px);
      transition:.2s ease;
    }
    body.state-chase .controls{opacity:1; transform:none;}

    .dpad{
      pointer-events:auto;
      display:grid;
      grid-template-columns: 56px 56px 56px;
      grid-template-rows: 56px 56px 56px;
      gap:10px;
      filter: drop-shadow(0 20px 44px rgba(0,0,0,.45));
    }
    .pad{
      width:56px; height:56px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
      display:grid; place-items:center;
      color:var(--text);
      font-weight:900;
      user-select:none;
      touch-action:none;
    }
    .pad:active{transform:translateY(2px)}
    .padGhost{opacity:0}

    .sideHint{
      pointer-events:none;
      max-width: 320px;
      text-align:right;
      font-size:12px;
      font-weight:850;
      color:var(--muted);
      line-height:1.35;
      text-shadow: 0 2px 0 rgba(0,0,0,.25);
    }

    /* Center overlay: TRY AGAIN / FINALLY TOGETHER */
    #centerOverlay{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      pointer-events:auto;
      background: radial-gradient(600px 380px at 50% 45%, rgba(0,0,0,.55), rgba(0,0,0,.25) 60%, rgba(0,0,0,0) 100%);
    }
    #centerOverlay.show{display:grid;}
    .centerText{
      text-align:center;
      padding:14px 18px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(18,26,52,.65), rgba(10,14,28,.65));
      box-shadow: 0 28px 90px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      cursor:pointer;
      user-select:none;
    }
    .centerText .big{
      font-size: clamp(40px, 8vw, 92px);
      font-weight: 1000;
      letter-spacing: 1.5px;
      line-height: 1;
      text-transform: uppercase;
      text-shadow: 0 10px 28px rgba(0,0,0,.45);
    }
    .centerText .sub{
      margin-top:10px;
      font-size: 13px;
      font-weight: 850;
      color: var(--muted);
    }
    .blink90{ animation: blink 0.38s steps(2,end) infinite; }

    /* Quiz overlay */
    #quiz{
      position:absolute; inset:0;
      display:none;
      pointer-events:auto;
    }
    body.state-quiz #quiz{display:block}

    .quizCard{
      pointer-events:auto;
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:min(980px, 92vw);
      border-radius:20px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(18,26,52,.70), rgba(10,14,28,.70));
      box-shadow: 0 28px 90px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      padding:16px;
    }
    .quizHead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .quizHead h2{margin:0; font-size:18px; letter-spacing:.2px;}
    .quizHead .meta{color:var(--muted); font-weight:850; font-size:13px;}
    .qtext{margin:10px 0 12px; font-size:16px; font-weight:900; line-height:1.35;}
    .options{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width: 760px){ .options{grid-template-columns: 1fr 1fr 1fr;} }
    .opt{
      text-align:left;
      font-weight:900;
      border-radius:16px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--text);
    }
    .opt:hover{filter:brightness(1.06)}
    .bar{margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; color:var(--muted); font-weight:850; font-size:13px; flex-wrap:wrap;}
    .meter{width:min(280px, 60vw); height:12px; border-radius:999px; border:1px solid var(--stroke); background: rgba(0,0,0,.22); overflow:hidden;}
    .fill{height:100%; width:100%; transform-origin:left center; background: linear-gradient(90deg, rgba(70,255,210,.9), rgba(255,209,102,.9), rgba(255,77,109,.9));}
    .danger{color:var(--pink)}
    #retry{display:none; margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,.12); text-align:center; width:100%;}
    #retry .msg{color:var(--amber); font-weight:900; margin: 0 0 10px; line-height:1.35;}

    @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }

    @media (prefers-reduced-motion: reduce){
      #centerOverlay .blink90{animation:none}
      .toast, .topbar, .controls{transition:none}
      svg .blink, svg .pulse {animation:none !important}
    }
  </style>
</head>

<body class="state-title">
<div id="app">
  <div id="sceneWrap">

    <svg id="svg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet" aria-label="Ettore & Patry game">
      <defs>
        <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0" stop-color="#1B2C6A"/>
          <stop offset=".55" stop-color="#0B1230"/>
          <stop offset="1" stop-color="#070A16"/>
        </linearGradient>

        <filter id="softShadow" x="-40%" y="-40%" width="180%" height="180%">
          <feDropShadow dx="0" dy="10" stdDeviation="12" flood-color="rgba(0,0,0,.45)"/>
        </filter>

        <filter id="glowAqua" x="-40%" y="-40%" width="180%" height="180%">
          <feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="rgba(70,255,210,.45)"/>
        </filter>

        <filter id="glowPink" x="-40%" y="-40%" width="180%" height="180%">
          <feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="rgba(255,77,109,.45)"/>
        </filter>

        <pattern id="plaid" width="24" height="24" patternUnits="userSpaceOnUse">
          <rect width="24" height="24" fill="#B12B3B"/>
          <rect x="0" y="9" width="24" height="4" fill="rgba(255,255,255,.14)"/>
          <rect x="9" y="0" width="4" height="24" fill="rgba(255,255,255,.14)"/>
          <rect x="0" y="16" width="24" height="3" fill="rgba(0,0,0,.12)"/>
          <rect x="16" y="0" width="3" height="24" fill="rgba(0,0,0,.12)"/>
        </pattern>

        <path id="heartPath" d="M 0 -16 C 0 -28 -16 -32 -26 -20 C -36 -8 -28 6 0 22 C 28 6 36 -8 26 -20 C 16 -32 0 -28 0 -16 Z"/>

        <g id="ettoreDef">
          <rect x="24" y="18" width="72" height="70" rx="24" fill="#F2C9A0"/>
          <path d="M22 34 C 26 8 94 8 98 34 L98 44 C 92 24 28 24 22 44 Z" fill="#2A1F1A"/>
          <circle cx="102" cy="38" r="12" fill="#2A1F1A"/>
          <rect x="30" y="44" width="24" height="16" rx="7" fill="none" stroke="#111" stroke-width="3"/>
          <rect x="66" y="44" width="24" height="16" rx="7" fill="none" stroke="#111" stroke-width="3"/>
          <line x1="54" y1="52" x2="66" y2="52" stroke="#111" stroke-width="3"/>
          <path d="M32 66 C 40 92 80 92 88 66 C 90 92 78 104 60 104 C 42 104 30 92 32 66 Z" fill="#3B2A22"/>
          <rect x="18" y="92" width="84" height="78" rx="18" fill="url(#plaid)"/>
          <rect x="30" y="170" width="60" height="44" rx="16" fill="#223255"/>
          <path d="M12 112 C 2 126 8 154 22 164" stroke="#F2C9A0" stroke-width="12" stroke-linecap="round"/>
          <path d="M108 112 C 118 126 112 154 98 164" stroke="#F2C9A0" stroke-width="12" stroke-linecap="round"/>
        </g>

        <g id="patryDef">
          <path d="M30 16 C 12 24 10 54 20 70 C 16 72 12 84 22 90 C 36 96 76 96 90 88 C 98 84 96 72 92 70 C 102 52 96 24 78 16 C 70 10 38 10 30 16 Z"
                fill="#1A1A1D"/>
          <rect x="28" y="26" width="64" height="62" rx="22" fill="#F3C8A1"/>
          <rect x="34" y="46" width="22" height="14" rx="6" fill="none" stroke="#111" stroke-width="3"/>
          <rect x="64" y="46" width="22" height="14" rx="6" fill="none" stroke="#111" stroke-width="3"/>
          <line x1="56" y1="53" x2="64" y2="53" stroke="#111" stroke-width="3"/>
          <circle cx="45" cy="56" r="3.2" fill="#2CFF88"/>
          <circle cx="75" cy="56" r="3.2" fill="#2CFF88"/>
          <path d="M34 92 C 34 130 86 130 86 92 L86 118 C 86 146 34 146 34 118 Z" fill="#4B3B92"/>
          <path d="M20 98 C 10 106 12 122 22 128" stroke="#F3C8A1" stroke-width="10" stroke-linecap="round"/>
          <path d="M100 98 C 110 106 108 122 98 128" stroke="#F3C8A1" stroke-width="10" stroke-linecap="round"/>
        </g>
      </defs>

      <!-- BACKGROUND -->
      <g id="bg">
        <rect x="0" y="0" width="1000" height="600" fill="url(#sky)"/>
        <g id="stars" opacity=".45"></g>
        <g id="skylineFar" opacity=".22">
          <path d="M0 440 L0 420 L40 420 L40 398 L70 398 L70 430 L110 430 L110 410 L145 410 L145 392 L190 392 L190 430 L240 430 L240 402 L270 402 L270 430 L320 430 L320 390 L360 390 L360 440 Z" fill="#000"/>
          <path d="M360 440 L360 410 L400 410 L400 380 L430 380 L430 420 L470 420 L470 400 L510 400 L510 360 L540 360 L540 420 L585 420 L585 398 L620 398 L620 430 L660 430 L660 390 L710 390 L710 440 Z" fill="#000"/>
          <path d="M710 440 L710 410 L750 410 L750 380 L790 380 L790 420 L830 420 L830 395 L880 395 L880 430 L920 430 L920 390 L970 390 L970 440 Z" fill="#000"/>
        </g>
        <rect x="0" y="430" width="1000" height="170" fill="rgba(0,0,0,.25)"/>
        <path d="M60 520 C 240 470 360 470 520 520 C 680 570 800 570 940 520"
              stroke="rgba(70,255,210,.14)" stroke-width="6" stroke-linecap="round" fill="none"/>
      </g>

      <!-- TITLE LAYER -->
      <g id="titleLayer">
        <g id="twoTowers" filter="url(#softShadow)">
          <path d="M160 510 C 280 470 420 458 500 458 C 580 458 720 470 840 510 L840 560 L160 560 Z"
                fill="rgba(0,0,0,.25)"/>
          <g transform="translate(430 140)">
            <path d="M40 0 L100 0 L120 360 L20 360 Z" fill="#1A1F2E"/>
            <path d="M40 0 L100 0" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
            <g fill="#1A1F2E">
              <rect x="38" y="-14" width="16" height="14" rx="3"/>
              <rect x="60" y="-14" width="16" height="14" rx="3"/>
              <rect x="82" y="-14" width="16" height="14" rx="3"/>
            </g>
            <g opacity=".55" fill="rgba(70,255,210,.35)">
              <rect x="52" y="40" width="10" height="18" rx="3"/>
              <rect x="78" y="40" width="10" height="18" rx="3"/>
              <rect x="52" y="85" width="10" height="18" rx="3"/>
              <rect x="78" y="85" width="10" height="18" rx="3"/>
              <rect x="52" y="130" width="10" height="18" rx="3"/>
              <rect x="78" y="130" width="10" height="18" rx="3"/>
              <rect x="52" y="175" width="10" height="18" rx="3"/>
              <rect x="78" y="175" width="10" height="18" rx="3"/>
              <rect x="52" y="220" width="10" height="18" rx="3"/>
              <rect x="78" y="220" width="10" height="18" rx="3"/>
            </g>
          </g>

          <g transform="translate(575 220) rotate(-6)">
            <path d="M0 0 L72 0 L92 280 L-18 280 Z" fill="#171C2A"/>
            <g fill="#171C2A">
              <rect x="-2" y="-14" width="16" height="14" rx="3"/>
              <rect x="18" y="-14" width="16" height="14" rx="3"/>
              <rect x="38" y="-14" width="16" height="14" rx="3"/>
              <rect x="58" y="-14" width="16" height="14" rx="3"/>
            </g>
            <g opacity=".45" fill="rgba(70,255,210,.30)">
              <rect x="10" y="50" width="10" height="18" rx="3"/>
              <rect x="32" y="50" width="10" height="18" rx="3"/>
              <rect x="54" y="50" width="10" height="18" rx="3"/>
              <rect x="10" y="100" width="10" height="18" rx="3"/>
              <rect x="32" y="100" width="10" height="18" rx="3"/>
              <rect x="54" y="100" width="10" height="18" rx="3"/>
              <rect x="10" y="150" width="10" height="18" rx="3"/>
              <rect x="32" y="150" width="10" height="18" rx="3"/>
              <rect x="54" y="150" width="10" height="18" rx="3"/>
            </g>
          </g>

          <path d="M200 510 C 310 485 420 476 500 476 C 580 476 690 485 800 510"
                stroke="rgba(70,255,210,.22)" stroke-width="3" fill="none" filter="url(#glowAqua)"/>
        </g>

        <!-- Personaggi in title screen (pi√π piccoli) -->
        <g filter="url(#softShadow)">
          <g transform="translate(210 330) scale(0.62)">
            <use href="#ettoreDef"/>
          </g>
          <g transform="translate(760 330) scale(0.62)">
            <use href="#patryDef"/>
            <g transform="translate(-180 18) scale(1.35)">
              <rect x="0" y="0" width="160" height="66" rx="14" fill="rgba(255,255,255,.95)" stroke="rgba(0,0,0,.18)"/>
              <text x="80" y="28" text-anchor="middle" font-size="15" font-weight="1000" fill="#111">PROVA A</text>
              <text x="80" y="50" text-anchor="middle" font-size="15" font-weight="1000" fill="#111">PRENDERMI</text>
            </g>
          </g>
        </g>

        <g id="titleText" font-weight="900" text-anchor="middle" filter="url(#softShadow)">
          <text x="500" y="70" font-size="44" fill="rgba(255,255,255,.92)">5 YEARS: SURVIVAL</text>
          <text x="500" y="114" font-size="36" fill="rgba(255,255,255,.86)">ANNIVERSARY MODE</text>
          <text id="glitchA" class="blink" x="500" y="70" font-size="44" fill="rgba(70,255,210,.50)" filter="url(#glowAqua)">5 YEARS: SURVIVAL</text>
          <text id="glitchB" class="blink" x="500" y="70" font-size="44" fill="rgba(255,77,109,.45)" filter="url(#glowPink)">5 YEARS: SURVIVAL</text>
        </g>

        <g id="pressStart" class="blink clickable" text-anchor="middle" filter="url(#glowPink)">
          <text x="500" y="520" font-size="26" fill="rgba(255,209,102,.95)" font-weight="1000">PRESS START</text>
        </g>

        <g id="startButton" class="clickable pulse" filter="url(#softShadow)">
          <rect x="360" y="420" width="280" height="74" rx="22"
                fill="rgba(70,255,210,.18)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
          <text x="500" y="468" text-anchor="middle" font-size="30" font-weight="1000"
                fill="rgba(255,255,255,.92)">START</text>
        </g>
      </g>

      <!-- CHASE LAYER (NO METRO) -->
      <g id="chaseLayer" opacity="0">
        <g id="olds"></g>
        <g id="baguettes"></g>

        <!-- Patry -->
        <g id="patry" filter="url(#softShadow)">
          <use href="#patryDef"/>
          <g id="sign" transform="translate(-190 10) scale(1.40)" filter="url(#softShadow)">
            <rect x="0" y="0" width="170" height="70" rx="14" fill="rgba(255,255,255,.96)" stroke="rgba(0,0,0,.18)"/>
            <text x="85" y="30" text-anchor="middle" font-size="16" font-weight="1000" fill="#111">PROVA A</text>
            <text x="85" y="54" text-anchor="middle" font-size="16" font-weight="1000" fill="#111">PRENDERMI</text>
          </g>
        </g>

        <!-- Ettore -->
        <g id="ettore" filter="url(#softShadow)">
          <use href="#ettoreDef"/>
        </g>

        <line id="targetLine" x1="0" y1="0" x2="0" y2="0" stroke="rgba(70,255,210,.18)" stroke-width="3" stroke-linecap="round"/>
      </g>

      <!-- QUIZ BACKGROUND LAYER -->
      <g id="quizBgLayer" opacity="0">
        <g id="qbg0" opacity="0">
          <rect x="0" y="0" width="1000" height="600" fill="url(#sky)"/>
          <g opacity=".22">
            <circle cx="170" cy="210" r="90" fill="rgba(70,255,210,.45)"/>
            <circle cx="850" cy="260" r="120" fill="rgba(255,77,109,.35)"/>
          </g>
          <rect x="220" y="190" width="560" height="120" rx="22" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.14)"/>
          <text x="500" y="245" text-anchor="middle" font-size="34" font-weight="1000" fill="rgba(70,255,210,.95)" filter="url(#glowAqua)">PRIMO DATE</text>
          <text x="500" y="280" text-anchor="middle" font-size="18" font-weight="900" fill="rgba(255,255,255,.80)">dove tutto √® iniziato‚Ä¶</text>
        </g>

        <g id="qbg1" opacity="0">
          <rect x="0" y="0" width="1000" height="600" fill="url(#sky)"/>
          <g opacity=".18">
            <path d="M140 440 C 240 360 360 360 460 440 C 560 520 680 520 860 380" stroke="rgba(255,255,255,.55)" stroke-width="14" stroke-linecap="round" fill="none"/>
          </g>
          <rect x="220" y="190" width="560" height="120" rx="22" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.14)"/>
          <text x="500" y="245" text-anchor="middle" font-size="34" font-weight="1000" fill="rgba(255,209,102,.95)" filter="url(#glowPink)">MOOD CHECK</text>
          <text x="500" y="280" text-anchor="middle" font-size="18" font-weight="900" fill="rgba(255,255,255,.80)">quando Patry √® scocciata‚Ä¶</text>
        </g>

        <g id="qbg2" opacity="0">
          <rect x="0" y="0" width="1000" height="600" fill="url(#sky)"/>
          <g opacity=".22">
            <rect x="120" y="340" width="760" height="180" rx="26" fill="rgba(255,255,255,.08)"/>
            <g stroke="rgba(255,255,255,.20)" stroke-width="6">
              <line x1="160" y1="380" x2="840" y2="380"/>
              <line x1="160" y1="430" x2="840" y2="430"/>
              <line x1="160" y1="480" x2="840" y2="480"/>
            </g>
          </g>
          <rect x="200" y="170" width="600" height="140" rx="22" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.14)"/>
          <text x="500" y="225" text-anchor="middle" font-size="30" font-weight="1000" fill="rgba(255,77,109,.95)" filter="url(#glowPink)">PARKING PANIC</text>
          <text x="500" y="265" text-anchor="middle" font-size="18" font-weight="900" fill="rgba(255,255,255,.80)">quasi-bloccati: storia vera</text>
        </g>

        <g id="qbg3" opacity="0">
          <rect x="0" y="0" width="1000" height="600" fill="url(#sky)"/>
          <g opacity=".28">
            <circle cx="260" cy="420" r="44" fill="rgba(255,209,102,.65)"/>
            <rect x="240" y="380" width="40" height="26" rx="8" fill="rgba(255,77,109,.55)"/>
            <circle cx="500" cy="420" r="44" fill="rgba(255,209,102,.65)"/>
            <rect x="480" y="380" width="40" height="26" rx="8" fill="rgba(255,77,109,.55)"/>
            <circle cx="740" cy="420" r="44" fill="rgba(255,209,102,.65)"/>
            <rect x="720" y="380" width="40" height="26" rx="8" fill="rgba(255,77,109,.55)"/>
          </g>
          <rect x="220" y="190" width="560" height="120" rx="22" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.14)"/>
          <text x="500" y="245" text-anchor="middle" font-size="34" font-weight="1000" fill="rgba(70,255,210,.95)" filter="url(#glowAqua)">DESSERT COCCOLA</text>
          <text x="500" y="280" text-anchor="middle" font-size="18" font-weight="900" fill="rgba(255,255,255,.80)">quando siete gi√π‚Ä¶</text>
        </g>

        <g id="qbg4" opacity="0">
          <rect x="0" y="0" width="1000" height="600" fill="url(#sky)"/>
          <g opacity=".25">
            <g transform="translate(180 240) scale(2.2)"><use href="#heartPath" fill="rgba(255,77,109,.55)"/></g>
            <g transform="translate(820 300) scale(2.8)"><use href="#heartPath" fill="rgba(255,77,109,.35)"/></g>
            <g transform="translate(560 460) scale(3.4)"><use href="#heartPath" fill="rgba(255,77,109,.28)"/></g>
          </g>
          <rect x="220" y="190" width="560" height="120" rx="22" fill="rgba(0,0,0,.25)" stroke="rgba(255,255,255,.14)"/>
          <text x="500" y="245" text-anchor="middle" font-size="34" font-weight="1000" fill="rgba(255,77,109,.95)" filter="url(#glowPink)">NICKNAME QUEST</text>
          <text x="500" y="280" text-anchor="middle" font-size="18" font-weight="900" fill="rgba(255,255,255,.80)">come vi chiamate di solito?</text>
        </g>
      </g>

      <g id="giftLayer" opacity="0"></g>

      <style>
        .blink{ animation: blink 0.38s steps(2,end) infinite; }
        #glitchA{ animation-duration: 0.65s; transform: translate(2px, -1px); opacity:.65; }
        #glitchB{ animation-duration: 0.65s; animation-delay: 0.12s; transform: translate(-2px, 1px); opacity:.55; }
        .pulse{ animation: pulse 1.25s ease-in-out infinite; transform-origin: 500px 457px; }
        .clickable{ cursor:pointer; pointer-events: all; }
        #startButton:hover rect{ filter: brightness(1.14); }
        @keyframes pulse { 0%,100%{ transform: scale(1) } 50%{ transform: scale(1.03) } }
      </style>
    </svg>

    <!-- UI overlay -->
    <div class="ui">
      <div class="topbar">
        <div class="pill">üéÆ <span>5 YEARS</span> <small id="levelLbl">‚Äî CHASE</small></div>
        <div class="pill">Obiettivo: <span style="color:var(--aqua); font-weight:1000;">raggiungi Patry</span></div>
      </div>

      <div id="toast" class="toast"></div>

      <div class="titleCard">
        <div class="left">
          <div class="hint"><b>PC:</b> WASD / frecce ‚Ä¢ <b>Mobile:</b> pad in basso</div>
          <div class="hint" style="opacity:.9">Schiva <b>baguette</b> e <b>vecchi fumatori</b>. Se ti prendono: <b>TRY AGAIN</b> (clicca per ricominciare).</div>
        </div>
        <div class="btnRow">
          <button id="startBtn" type="button">START</button>
          <button id="muteBtn" type="button" class="secondary">Audio: ON</button>
        </div>
      </div>

      <div class="controls">
        <div class="dpad">
          <div class="pad padGhost"></div>
          <div class="pad" data-dir="up">‚ñ≤</div>
          <div class="pad padGhost"></div>
          <div class="pad" data-dir="left">‚óÄ</div>
          <div class="pad" data-dir="down">‚ñº</div>
          <div class="pad" data-dir="right">‚ñ∂</div>
          <div class="pad padGhost"></div>
          <div class="pad padGhost"></div>
          <div class="pad padGhost"></div>
        </div>
        <div class="sideHint"><b>TIP:</b> resta in movimento: i vecchi ti inseguono üë¥üö¨</div>
      </div>

      <div id="centerOverlay">
        <div id="centerText" class="centerText">
          <div id="centerBig" class="big blink90">TRY AGAIN</div>
          <div id="centerSub" class="sub">Clicca per ricominciare</div>
        </div>
      </div>

      <div id="quiz">
        <div class="quizCard">
          <div class="quizHead">
            <h2 id="qtitle">QUIZ A TEMPO ‚Äî 10s</h2>
            <div class="meta">Domanda <span id="qindex">1</span>/5 ‚Ä¢ ‚è± <span id="tleft">10</span>s</div>
          </div>
          <div class="qtext" id="qtext"></div>
          <div class="options" id="options"></div>
          <div class="bar">
            <div class="meter"><div class="fill" id="tfill"></div></div>
            <div id="retry">
              <p class="msg" id="retryMsg"></p>
              <button id="retryBtn" type="button">Ritenta il quiz</button>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
(() => {
  const body = document.body;
  const svg = document.getElementById('svg');

  // Responsive camera (fit viewBox)
  function fitViewBox(){
    if(!svg) return;
    const baseW = 1000, baseH = 600;
    const baseAR = baseW / baseH;
    const vw = (window.visualViewport && window.visualViewport.width)  ? window.visualViewport.width  : window.innerWidth;
    const vh = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
    const screenAR = vw / vh;

    let vbX = 0, vbY = 0, vbW = baseW, vbH = baseH;
    if(screenAR < baseAR){
      vbH = baseW / screenAR;
      vbY = (baseH - vbH) / 2;
    } else {
      vbW = baseH * screenAR;
      vbX = (baseW - vbW) / 2;
    }
    svg.setAttribute('viewBox', `${vbX} ${vbY} ${vbW} ${vbH}`);
  }
  fitViewBox();
  window.addEventListener('resize', () => requestAnimationFrame(fitViewBox));
  window.addEventListener('orientationchange', () => setTimeout(fitViewBox, 150));
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', () => requestAnimationFrame(fitViewBox));
  }

  // DOM
  const stars = document.getElementById('stars');
  const titleLayer = document.getElementById('titleLayer');
  const chaseLayer = document.getElementById('chaseLayer');
  const quizBgLayer = document.getElementById('quizBgLayer');
  const giftLayer = document.getElementById('giftLayer');

  const oldsG = document.getElementById('olds');
  const baguettesG = document.getElementById('baguettes');

  const ettore = document.getElementById('ettore');
  const patry = document.getElementById('patry');
  const targetLine = document.getElementById('targetLine');

  const pressStart = document.getElementById('pressStart');
  const startButton = document.getElementById('startButton');

  const toast = document.getElementById('toast');
  const startBtn = document.getElementById('startBtn');
  const muteBtn = document.getElementById('muteBtn');

  const centerOverlay = document.getElementById('centerOverlay');
  const centerBig = document.getElementById('centerBig');
  const centerSub = document.getElementById('centerSub');

  // Quiz UI
  const qtitle = document.getElementById('qtitle');
  const qindexEl = document.getElementById('qindex');
  const qtextEl = document.getElementById('qtext');
  const optionsEl = document.getElementById('options');
  const tleftEl = document.getElementById('tleft');
  const tfillEl = document.getElementById('tfill');
  const retryBox = document.getElementById('retry');
  const retryMsg = document.getElementById('retryMsg');
  const retryBtn = document.getElementById('retryBtn');

  const qbg = [
    document.getElementById('qbg0'),
    document.getElementById('qbg1'),
    document.getElementById('qbg2'),
    document.getElementById('qbg3'),
    document.getElementById('qbg4'),
  ];

  // Helpers
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const rand = (a,b) => a + Math.random()*(b-a);
  const pick = (arr) => arr[(Math.random()*arr.length)|0];
  const now = () => performance.now();

  function setOpacity(el, v){ el.setAttribute('opacity', String(v)); }
  function setTransformScale(el, x, y, s){ el.setAttribute('transform', `translate(${x} ${y}) scale(${s})`); }

  // HITBOX: tolleranza -> hitbox pi√π stretta (collisione pi√π "diretta")
  // padA/padB: quanti px togliere dai lati (shrink). Aumenta per rendere pi√π permissivo.
  function rectsOverlap(a,b, padA=0, padB=0){
    const ax = a.x + padA;
    const ay = a.y + padA;
    const aw = Math.max(0, a.w - padA*2);
    const ah = Math.max(0, a.h - padA*2);

    const bx = b.x + padB;
    const by = b.y + padB;
    const bw = Math.max(0, b.w - padB*2);
    const bh = Math.max(0, b.h - padB*2);

    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  // Audio
  let audioOn = true;
  let audioCtx = null;
  function beep(freq=440, dur=0.08, type='sine', gain=0.03){
    if(!audioOn) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + dur);
    }catch(_){}
  }
  function ensureAudioContext(){
    if(audioOn && !audioCtx){
      try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(_){}
    }
  }

  // Toast
  let toastTimer = 0;
  function showToast(msg, ms=1400){
    toast.textContent = msg;
    toast.classList.add('show');
    toastTimer = ms;
  }

  // State
  const State = { TITLE:'title', CHASE:'chase', QUIZ:'quiz', GIFT:'gift' };
  let state = State.TITLE;

  function setState(s){
    state = s;
    body.classList.remove('state-title','state-chase','state-quiz','state-gift');
    body.classList.add(`state-${s}`);

    if(s === State.TITLE){
      setOpacity(titleLayer, 1); setOpacity(chaseLayer, 0); setOpacity(quizBgLayer, 0); setOpacity(giftLayer, 0);
    }else if(s === State.CHASE){
      setOpacity(titleLayer, 0); setOpacity(chaseLayer, 1); setOpacity(quizBgLayer, 0); setOpacity(giftLayer, 0);
    }else if(s === State.QUIZ){
      setOpacity(titleLayer, 0); setOpacity(chaseLayer, 0); setOpacity(quizBgLayer, 1); setOpacity(giftLayer, 0);
    }else if(s === State.GIFT){
      setOpacity(titleLayer, 0); setOpacity(chaseLayer, 0); setOpacity(quizBgLayer, 0); setOpacity(giftLayer, 1);
    }
  }

  // Stars
  function buildStars(group, count){
    if(!group) return;
    group.innerHTML = '';
    for(let i=0;i<count;i++){
      const cx = rand(0, 1000), cy = rand(0, 420);
      const r = rand(0.7, 1.8);
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute('cx', cx);
      c.setAttribute('cy', cy);
      c.setAttribute('r', r);
      c.setAttribute('fill', 'rgba(255,255,255,.85)');
      c.setAttribute('opacity', String(rand(0.25, 0.9)));
      group.appendChild(c);
    }
  }
  buildStars(stars, 110);

  // -------------------------------
  // CHASE GAME (ONLY olds + baguettes)
  // -------------------------------
  const SCALE_E = 0.55;
  const SCALE_P = 0.55;

  // padding hitbox (collisioni pi√π "dirette")
  const HIT_PLAYER = 18;   // quanto stringere Ettore
  const HIT_OLD    = 14;   // quanto stringere i vecchi
  const HIT_BAG    = 6;    // quanto stringere le baguette

  const player = { x: 110, y: 490, w: 72, h: 128, speed: 600 };
  const girl   = { x: 860, y: 75,  w: 125, h: 125 };

  let olds = [];
  let baguettes = [];
  let baguetteSpawn = 0;

  function oldManSVG(){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute('filter','url(#softShadow)');
    g.innerHTML = `
      <g>
        <rect x="18" y="20" width="56" height="54" rx="18" fill="#EBC6A1"/>
        <path d="M18 44 C 22 16 74 16 74 44" fill="#B9B9B9"/>
        <circle cx="32" cy="44" r="3" fill="#111"/>
        <circle cx="60" cy="44" r="3" fill="#111"/>
        <path d="M36 58 C 44 64 54 64 62 58" stroke="#6B3B2A" stroke-width="6" stroke-linecap="round"/>
        <path d="M10 74 C 10 60 82 60 82 74 L82 118 C 82 130 74 140 60 140 L32 140 C 18 140 10 130 10 118 Z"
              fill="rgba(255,209,102,.18)" stroke="rgba(255,209,102,.35)" stroke-width="2"/>
        <path d="M18 104 L30 90 L38 110 L48 92 L58 112 L68 96 L76 112"
              stroke="rgba(0,0,0,.22)" stroke-width="4" stroke-linecap="round" fill="none"/>
        <path d="M6 88 C -2 98 2 116 12 126" stroke="#EBC6A1" stroke-width="10" stroke-linecap="round"/>
        <path d="M80 90 C 92 92 98 104 94 116 C 92 124 86 130 78 134" stroke="#EBC6A1" stroke-width="10" stroke-linecap="round"/>
        <rect x="92" y="100" width="18" height="5" rx="2.5" fill="#F2F2F2"/>
        <rect x="108" y="100" width="5" height="5" rx="2.5" fill="#FF4D6D"/>
        <path d="M110 92 C 116 86 120 78 116 70" stroke="rgba(255,255,255,.35)" stroke-width="3" stroke-linecap="round" fill="none"/>
      </g>
    `;
    return g;
  }

  function drawOlds(){
    oldsG.innerHTML = '';
    for(const o of olds){
      const el = oldManSVG();
      el.setAttribute('id', o.id);
      oldsG.appendChild(el);
      o.el = el;
      setTransformScale(o.el, o.x, o.y, 0.62);
    }
  }

  function makeBaguette(){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute('filter','url(#softShadow)');
    g.innerHTML = `
      <g transform="rotate(-8)">
        <rect x="0" y="0" width="90" height="26" rx="13" fill="#E7C178"/>
        <path d="M16 8 L24 18 M34 8 L42 18 M52 8 L60 18 M70 8 L78 18"
              stroke="rgba(120,70,20,.35)" stroke-width="4" stroke-linecap="round"/>
      </g>`;
    return g;
  }

  function buildLevel(){
    player.x = 110; player.y = 490;
    girl.x = 860; girl.y = 75;

    baguettes = [];
    baguettesG.innerHTML = '';
    baguetteSpawn = 0.35;

    // Old smokers spawn (SOLO 3 + pi√π lenti)
    const spawns = [
      {x: 260, y: 320},
      {x: 520, y: 520},
      {x: 780, y: 360},
    ];
    olds = [];
    for(let i=0;i<spawns.length;i++){
      olds.push({
        id: 'old'+i,
        x: spawns[i].x,
        y: spawns[i].y,
        w: 68, h: 110,
        speed: rand(45, 65),  // rallentati
        wob: rand(0, 10),
        el: null,
      });
    }
    drawOlds();

    setTransformScale(ettore, player.x, player.y, SCALE_E);
    setTransformScale(patry, girl.x, girl.y, SCALE_P);
  }

  // Input
  const keys = {up:false,down:false,left:false,right:false};

  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(k) || k===' '){
      e.preventDefault();
    }
    if(k==='arrowup' || k==='w') keys.up=true;
    if(k==='arrowdown'|| k==='s') keys.down=true;
    if(k==='arrowleft'|| k==='a') keys.left=true;
    if(k==='arrowright'|| k==='d') keys.right=true;
  }, {passive:false});

  window.addEventListener('keyup', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup' || k==='w') keys.up=false;
    if(k==='arrowdown'|| k==='s') keys.down=false;
    if(k==='arrowleft'|| k==='a') keys.left=false;
    if(k==='arrowright'|| k==='d') keys.right=false;
  });

  const activeDirs = new Set();
  document.querySelectorAll('.pad').forEach(btn=>{
    const dir = btn.dataset.dir;
    if(!dir) return;
    const on = (e)=>{ e.preventDefault(); activeDirs.add(dir); syncDirs(); };
    const off = (e)=>{ e.preventDefault(); activeDirs.delete(dir); syncDirs(); };
    btn.addEventListener('pointerdown', on, {passive:false});
    btn.addEventListener('pointerup', off, {passive:false});
    btn.addEventListener('pointercancel', off, {passive:false});
    btn.addEventListener('pointerleave', off, {passive:false});
  });
  function syncDirs(){
    keys.up = activeDirs.has('up');
    keys.down = activeDirs.has('down');
    keys.left = activeDirs.has('left');
    keys.right = activeDirs.has('right');
  }

  // Center overlay
  let overlayMode = 'none'; // none | try | win
  let winTimer = 0;

  function showTryAgain(){
    overlayMode = 'try';
    centerBig.textContent = 'TRY AGAIN';
    centerSub.textContent = 'Clicca per ricominciare';
    centerOverlay.classList.add('show');
    beep(160, .12, 'square', .06);
  }
  function showFinallyTogether(){
    overlayMode = 'win';
    centerBig.textContent = 'FINALLY TOGETHER!';
    centerSub.textContent = '‚Ä¶e ora il quiz!';
    centerOverlay.classList.add('show');
    beep(880, .09, 'triangle', .05);
    winTimer = 0.95;
  }
  function hideOverlay(){
    overlayMode = 'none';
    centerOverlay.classList.remove('show');
  }

  centerOverlay.addEventListener('click', (e)=>{
    e.preventDefault();
    if(overlayMode === 'try'){
      restartChase();
    }
  });
  window.addEventListener('keydown', (e)=>{
    if(overlayMode === 'try' && (e.key === 'Enter' || e.key === ' ')){
      e.preventDefault();
      restartChase();
    }
  }, {passive:false});

  // Game flow
  function restartChase(){
    hideOverlay();
    buildLevel();
    setState(State.CHASE);
    showToast("GO! Raggiungi Patry ‚ú®", 1000);
  }

  function enterChase(){
    buildLevel();
    hideOverlay();
    setState(State.CHASE);
    showToast("Vai Ettore! Schiva baguette e vecchi fumatori!", 1400);
    beep(520, .07, 'triangle', .03);
  }

  function startFromTitle(){
    if(state !== State.TITLE) return;
    ensureAudioContext();
    enterChase();
  }

  startBtn.addEventListener('click', (e)=>{ e.preventDefault(); startFromTitle(); });
  pressStart?.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startFromTitle(); }, {passive:false});
  startButton?.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startFromTitle(); }, {passive:false});
  window.addEventListener('keydown', (e)=>{
    if(state !== State.TITLE) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      startFromTitle();
    }
  }, {passive:false});

  muteBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    audioOn = !audioOn;
    muteBtn.textContent = `Audio: ${audioOn ? 'ON' : 'OFF'}`;
    beep(audioOn ? 600 : 200, .06, 'triangle', .03);
  });

  // -------------------------------
  // QUIZ
  // -------------------------------
  const wrongMessages = [
    "‚ùå NOPE. Per farti perdonare: offrire il sushi. Ora ritenta il quiz!",
    "‚ùå SBAGLIATO. Punizione: pulire i piatti per un mese senza lamentarsi. Ritenta!",
    "‚ùå AHI. Ti tocca: comprare una pianta grandissima da mettere in soggiorno (e curarla!). Ritenta!"
  ];
  const questions = [
    { bg:0, q:"Il posto del primo date?", opts:["Casa del popolo","Carmentown","Bar dell'ombra"], correct:1 },
    { bg:1, q:"Cosa fa Patry quando √® scocciata da qualcosa?", opts:["Sbuffino","Agita i pugni in aria","Fa bibi"], correct:0 },
    { bg:2, q:"La volta in cui ho rischiato molto di non festeggiare questo anniversario?", opts:[
      "Quando siamo rimasti quasi bloccati per due giorni con la macchina nel parcheggio di Almacube",
      "Quando non ho prenotato l'albergo in Grecia",
      "Quando mi sono addormentato alla guida facendoci quasi uscire dalla strada"
    ], correct:0 },
    { bg:3, q:"Qual √® il dessert coccola che ci regaliamo quando siamo gi√π?", opts:["San Salvatore","Pudding di chia","Gelato d'Azeglio"], correct:0 },
    { bg:4, q:"Il nomignolo pi√π usato per chiamarci?", opts:["Bubo/a","Cucci","Tesoro"], correct:0 },
  ];

  let qIndex = 0;
  let qTime = 10.0;
  let qRunning = false;

  function showQuizBg(i){
    qbg.forEach((g, idx)=> g.setAttribute('opacity', idx===i ? '1' : '0'));
  }
  function updateQuizMeter(){
    tleftEl.textContent = Math.ceil(qTime).toString();
    const ratio = clamp(qTime/10, 0, 1);
    tfillEl.style.transform = `scaleX(${ratio})`;
    tleftEl.classList.toggle('danger', qTime <= 3.2);
  }
  function setupQuestion(){
    const item = questions[qIndex];
    qtitle.textContent = "QUIZ A TEMPO ‚Äî 10s";
    qindexEl.textContent = (qIndex+1).toString();
    qtextEl.textContent = item.q;

    optionsEl.innerHTML = '';
    item.opts.forEach((txt, idx)=>{
      const b = document.createElement('button');
      b.className = 'opt';
      b.type = 'button';
      b.textContent = txt;
      b.addEventListener('click', ()=>answer(idx));
      optionsEl.appendChild(b);
    });

    qTime = 10.0;
    updateQuizMeter();
    showQuizBg(item.bg);
  }
  function failQuiz(){
    qRunning = false;
    retryMsg.textContent = pick(wrongMessages);
    retryBox.style.display = 'block';
    beep(180, .14, 'square', .05);
  }
  function answer(idx){
    if(!qRunning) return;
    const item = questions[qIndex];
    if(idx === item.correct){
      beep(880, .08, 'triangle', .04);
      qIndex++;
      if(qIndex >= questions.length){
        qRunning = false;
        showToast("Quiz completato! üéâ", 1400);
        setState(State.TITLE);
      }else{
        setupQuestion();
      }
    }else{
      failQuiz();
    }
  }
  retryBtn.addEventListener('click', ()=>{
    qIndex = 0;
    retryBox.style.display = 'none';
    setupQuestion();
    qRunning = true;
    beep(520, .07, 'triangle', .03);
  });

  function enterQuiz(){
    setState(State.QUIZ);
    qIndex = 0;
    retryBox.style.display = 'none';
    setupQuestion();
    qRunning = true;
    showToast("Quiz a tempo! 10 secondi per domanda ‚è±", 1200);
    beep(660, .08, 'triangle', .03);
  }

  // -------------------------------
  // Main loop
  // -------------------------------
  let t = 0;
  let last = now();

  function update(dt){
    if(toastTimer > 0){
      toastTimer -= dt*1000;
      if(toastTimer <= 0) toast.classList.remove('show');
    }

    const drift = Math.sin(t*0.0002)*6;
    const skylineFar = document.getElementById('skylineFar');
    if(skylineFar) skylineFar.setAttribute('transform', `translate(${drift} 0)`);

    // Handle overlay win timing
    if(overlayMode === 'win'){
      winTimer -= dt;
      if(winTimer <= 0){
        hideOverlay();
        enterQuiz();
      }
      return; // freeze game behind overlay
    }
    if(overlayMode === 'try'){
      return; // freeze game behind overlay
    }

    if(state === State.CHASE){
      // Player input
      let dx=0, dy=0;
      const sp = player.speed;
      if(keys.left) dx -= sp*dt;
      if(keys.right) dx += sp*dt;
      if(keys.up) dy -= sp*dt;
      if(keys.down) dy += sp*dt;
      if(dx && dy){ dx*=0.7071; dy*=0.7071; }

      player.x += dx;
      player.y += dy;

      // Bounds only (no metro, no other obstacles)
      player.x = clamp(player.x, 10, 930);
      player.y = clamp(player.y, 40, 520);

      // Old smokers chase Ettore
      const pCx = player.x + player.w/2;
      const pCy = player.y + player.h/2;

      for(const o of olds){
        // wob pi√π lento (prima 3.4) -> movimenti meno "nervosi"
        o.wob += dt * 2.0;

        const oCx = o.x + o.w/2;
        const oCy = o.y + o.h/2;
        let vx = (pCx - oCx);
        let vy = (pCy - oCy);
        const len = Math.hypot(vx,vy) || 1;
        vx /= len; vy /= len;

        vx += Math.sin(o.wob)*0.12;
        vy += Math.cos(o.wob*1.1)*0.10;

        const step = o.speed * dt;
        o.x += vx * step;
        o.y += vy * step;

        o.x = clamp(o.x, 10, 930);
        o.y = clamp(o.y, 60, 520);

        if(o.el) setTransformScale(o.el, o.x, o.y, 0.62);

        // TRY AGAIN SOLO se collisione diretta (hitbox pi√π stretta)
        if(rectsOverlap(player, o, HIT_PLAYER, HIT_OLD)){
          showTryAgain();
          return;
        }
      }

      // Spawn baguettes
      baguetteSpawn -= dt;
      if(baguetteSpawn <= 0){
        baguetteSpawn = rand(0.70, 1.10);
        const obj = {
          x: 1040,
          y: rand(90, 530),
          w: 90,
          h: 26,
          vx: rand(-650, -480),
          vy: rand(-30, 30),
          wob: rand(0, 10),
          el: makeBaguette()
        };
        baguettes.push(obj);
        baguettesG.appendChild(obj.el);
      }

      for(const bq of baguettes){
        bq.wob += dt*6.0;
        bq.x += bq.vx*dt;
        bq.y += bq.vy*dt + Math.sin(bq.wob)*18*dt;
        bq.el.setAttribute('transform', `translate(${bq.x} ${bq.y}) rotate(${Math.sin(bq.wob)*6} 45 13)`);
      }
      baguettes = baguettes.filter(bq=>{
        if(bq.x < -160){ bq.el.remove(); return false; }
        return true;
      });

      // Hit by baguette -> TRY AGAIN (hitbox pi√π stretta)
      for(const bq of baguettes){
        const bBox = {x:bq.x, y:bq.y, w:bq.w, h:bq.h};
        if(rectsOverlap(player, bBox, HIT_PLAYER, HIT_BAG)){
          showTryAgain();
          return;
        }
      }

      // Render characters
      setTransformScale(ettore, player.x, player.y, SCALE_E);
      setTransformScale(patry, girl.x, girl.y, SCALE_P);

      // Target line
      const px = player.x + player.w/2, py = player.y + player.h/2;
      const gx = girl.x + girl.w/2, gy = girl.y + girl.h/2;
      targetLine.setAttribute('x1', px);
      targetLine.setAttribute('y1', py);
      targetLine.setAttribute('x2', gx);
      targetLine.setAttribute('y2', gy);

      // Win condition (lasciata standard)
      const gBox = {x:girl.x, y:girl.y, w:girl.w, h:girl.h};
      if(rectsOverlap(player, gBox)){
        showFinallyTogether();
        return;
      }
    }

    if(state === State.QUIZ){
      if(qRunning){
        qTime -= dt;
        if(qTime <= 0){
          qTime = 0;
          updateQuizMeter();
          failQuiz();
        }else{
          updateQuizMeter();
        }
      }
    }
  }

  function frame(){
    const n = now();
    const dt = Math.min(0.06, (n-last)/1000);
    last = n;
    t = n;
    update(dt);
    requestAnimationFrame(frame);
  }

  // Init
  setState(State.TITLE);
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
