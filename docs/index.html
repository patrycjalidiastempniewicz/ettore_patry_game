<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>4 YEARS: SURVIVAL ANNIVERSARY MODE</title>

  <!-- Pixel-ish font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#05060B;
      --maze:#2E7DFF;
      --mazeGlow: rgba(46,125,255,.55);
      --text:#F6F8FF;
      --muted:#A7B0D6;
      --yellow:#FFD84D;
      --pink:#FF4DA0;
      --red:#FF2E2E;
      --stroke: rgba(255,255,255,.18);
      --shadow: rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(900px 520px at 50% 30%, #0A1030 0%, var(--bg) 55%, #02030A 100%);
      color:var(--text);
      overflow:hidden;
      min-height:100dvh;
    }

    #app{position:fixed; inset:0; height:100dvh;}
    #sceneWrap{position:relative; width:100%; height:100%; touch-action:none;}
    svg{width:100%; height:100%; display:block;}

    .ui{
      position:absolute; inset:0;
      pointer-events:auto;
      display:flex; flex-direction:column;
    }

    .topbar{
      display:flex; gap:10px; align-items:center;
      padding:12px;
      pointer-events:none;
      opacity:0;
      transform:translateY(-8px);
      transition:.2s ease;
    }
    body.state-chase .topbar{opacity:1; transform:none;}

    .pill{
      pointer-events:none;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: 0 18px 52px var(--shadow);
      backdrop-filter: blur(10px);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight:900;
      font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    .pill small{font-weight:900; color:var(--muted);}

    .toast{
      position:absolute; left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      width:min(920px, 92vw);
      padding:12px 14px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(12,18,44,.60), rgba(4,6,18,.60));
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      pointer-events:none;
      opacity:0;
      transition:.18s ease;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight:900;
      font-size:13px;
      text-align:center;
    }
    .toast.show{opacity:1}

    .titleCard{
      position:absolute;
      left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      width:min(980px, 92vw);
      padding:16px 16px 14px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(12,18,44,.66), rgba(4,6,18,.66));
      box-shadow: 0 26px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      pointer-events:auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    body.state-title .titleCard{display:flex}
    body:not(.state-title) .titleCard{display:none}

    .titleCard .left{
      display:flex; flex-direction:column; gap:6px; min-width:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .titleCard .left .hint{
      font-weight:900;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .btnRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    button{
      font: inherit;
      cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(46,125,255,.22), rgba(46,125,255,.08));
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight:1000;
      box-shadow: 0 18px 54px rgba(0,0,0,.40);
      transition: transform .08s ease, filter .08s ease;
      pointer-events:auto;
      touch-action: manipulation;
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform:translateY(2px)}
    .secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--muted);
      font-weight:950;
    }

    .controls{
      position:absolute;
      left:0; right:0;
      bottom: calc(88px + env(safe-area-inset-bottom));
      padding:0 14px;
      display:flex; justify-content:space-between; align-items:flex-end;
      pointer-events:auto;
      opacity:0; transform:translateY(8px);
      transition:.2s ease;
    }
    body.state-chase .controls{opacity:1; transform:none;}

    .dpad{
      pointer-events:auto;
      display:grid;
      grid-template-columns: 56px 56px 56px;
      grid-template-rows: 56px 56px 56px;
      gap:10px;
      filter: drop-shadow(0 22px 52px rgba(0,0,0,.55));
    }
    .pad{
      width:56px; height:56px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      display:grid; place-items:center;
      color:var(--text);
      font-weight:1000;
      user-select:none;
      touch-action:none;
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size:16px;
    }
    .pad:active{transform:translateY(2px)}
    .padGhost{opacity:0}

    .sideHint{
      pointer-events:none;
      max-width: 340px;
      text-align:right;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      line-height:1.35;
      text-shadow: 0 2px 0 rgba(0,0,0,.25);
    }

    /* Center overlay */
    #centerOverlay{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      pointer-events:auto;
      background:
        radial-gradient(650px 420px at 50% 45%, rgba(0,0,0,.70), rgba(0,0,0,.35) 55%, rgba(0,0,0,0) 100%);
    }
    #centerOverlay.show{display:grid;}
    .centerText{
      text-align:center;
      padding:16px 18px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(12,18,44,.72), rgba(4,6,18,.72));
      box-shadow: 0 30px 110px rgba(0,0,0,.60);
      backdrop-filter: blur(14px);
      cursor:pointer;
      user-select:none;
    }
    .centerText .big{
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: clamp(26px, 5.2vw, 58px);
      letter-spacing: 1.2px;
      line-height: 1.1;
      text-transform: uppercase;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
    }
    .centerText .sub{
      margin-top:12px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 13px;
      font-weight: 900;
      color: var(--muted);
    }
    .blink90{ animation: blink 0.38s steps(2,end) infinite; }

    /* Quiz overlay */
    #quiz{
      position:absolute; inset:0;
      display:none;
      pointer-events:auto;
    }
    body.state-quiz #quiz{display:block}
    .quizCard{
      pointer-events:auto;
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:min(980px, 92vw);
      border-radius:20px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(12,18,44,.76), rgba(4,6,18,.76));
      box-shadow: 0 30px 110px rgba(0,0,0,.60);
      backdrop-filter: blur(14px);
      padding:16px;
    }
    .quizHead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .quizHead h2{
      margin:0;
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size:14px;
      line-height:1.35;
      letter-spacing:.3px;
    }
    .quizHead .meta{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--muted);
      font-weight:950;
      font-size:13px;
    }
    .qtext{
      margin:12px 0 12px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size:16px;
      font-weight:1000;
      line-height:1.35;
    }
    .options{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width: 760px){ .options{grid-template-columns: 1fr 1fr 1fr;} }
    .opt{
      text-align:left;
      font-weight:1000;
      border-radius:16px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .opt:hover{filter:brightness(1.06)}
    .bar{margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; color:var(--muted); font-weight:950; font-size:13px; flex-wrap:wrap;}
    .meter{width:min(280px, 60vw); height:12px; border-radius:999px; border:1px solid var(--stroke); background: rgba(0,0,0,.22); overflow:hidden;}
    .fill{height:100%; width:100%; transform-origin:left center; background: linear-gradient(90deg, rgba(46,125,255,.95), rgba(255,216,77,.95), rgba(255,46,46,.95));}
    .danger{color:var(--red)}
    #retry{display:none; margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,.12); text-align:center; width:100%;}
    #retry .msg{color: #FFD84D; font-weight:1000; margin: 0 0 10px; line-height:1.35;}

    @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }

    @media (prefers-reduced-motion: reduce){
      .blink90{animation:none}
      .toast, .topbar, .controls{transition:none}
      svg .blink, svg .pulse, svg .floaty {animation:none !important}
    }
  </style>
</head>

<body class="state-title">
<div id="app">
  <div id="sceneWrap">

    <svg id="svg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet" aria-label="Ettore & Patry game pacman style">
      <defs>
        <filter id="mazeGlow" x="-60%" y="-60%" width="220%" height="220%">
          <feDropShadow dx="0" dy="0" stdDeviation="3" flood-color="rgba(46,125,255,.45)"/>
          <feDropShadow dx="0" dy="0" stdDeviation="7" flood-color="rgba(46,125,255,.22)"/>
        </filter>

        <filter id="softShadow" x="-50%" y="-50%" width="220%" height="220%">
          <feDropShadow dx="0" dy="12" stdDeviation="14" flood-color="rgba(0,0,0,.55)"/>
        </filter>

        <path id="ghostBody" d="M 0 36
          C 0 12 18 0 36 0
          C 54 0 72 12 72 36
          L 72 78
          C 64 74 60 74 52 78
          C 44 82 40 82 32 78
          C 24 74 20 74 12 78
          C 6 81 3 81 0 78
          Z"/>

        <!-- Pellets (decor) -->
        <circle id="pellet" cx="0" cy="0" r="3.2" />

        <!-- Ettore: Pac-man vibe (yellow orb) with beard + glasses -->
        <g id="ettorePac">
          <circle cx="48" cy="48" r="44" fill="var(--yellow)"/>
          <!-- mouth wedge (black cut-out) -->
          <g id="ettoreMouth">
            <path id="mouthOpen" d="M48 48 L92 30 L92 66 Z" fill="#05060B" opacity="0.92"/>
            <path id="mouthClosed" d="M48 48 L92 46 L92 50 Z" fill="#05060B" opacity="0"/>
          </g>
          <!-- beard -->
          <path d="M14 58 C 18 84 78 84 82 58 C 84 84 70 98 48 98 C 26 98 12 84 14 58 Z"
                fill="rgba(70,40,22,.90)"/>
          <!-- glasses -->
          <rect x="18" y="36" width="24" height="16" rx="6" fill="none" stroke="#0A0A0A" stroke-width="3"/>
          <rect x="54" y="36" width="24" height="16" rx="6" fill="none" stroke="#0A0A0A" stroke-width="3"/>
          <line x1="42" y1="44" x2="54" y2="44" stroke="#0A0A0A" stroke-width="3"/>
          <!-- eye dots -->
          <circle cx="30" cy="44" r="2.5" fill="#0A0A0A"/>
          <circle cx="66" cy="44" r="2.5" fill="#0A0A0A"/>
          <!-- hair curl tuft -->
          <path d="M30 14 C 22 10 18 18 24 24 C 30 30 22 34 18 28" fill="none" stroke="rgba(70,40,22,.9)" stroke-width="4" stroke-linecap="round"/>
        </g>

        <!-- Patry: pink orb w/ dark hair + glasses + green eyes + sign -->
        <g id="patryPac">
          <circle cx="48" cy="48" r="44" fill="var(--pink)"/>
          <!-- hair -->
          <path d="M16 34 C 20 10 78 10 82 34 C 74 28 68 28 60 32 C 52 36 44 36 36 32 C 28 28 22 28 16 34 Z"
                fill="rgba(10,10,14,.95)"/>
          <!-- glasses -->
          <rect x="18" y="40" width="24" height="16" rx="6" fill="none" stroke="#0A0A0A" stroke-width="3"/>
          <rect x="54" y="40" width="24" height="16" rx="6" fill="none" stroke="#0A0A0A" stroke-width="3"/>
          <line x1="42" y1="48" x2="54" y2="48" stroke="#0A0A0A" stroke-width="3"/>
          <circle cx="30" cy="48" r="3.2" fill="#36FF7A"/>
          <circle cx="66" cy="48" r="3.2" fill="#36FF7A"/>

          <!-- sign -->
          <g transform="translate(-176 8)" filter="url(#softShadow)">
            <rect x="0" y="0" width="168" height="72" rx="14" fill="rgba(255,255,255,.96)" stroke="rgba(0,0,0,.18)"/>
            <text x="84" y="30" text-anchor="middle" font-size="14" font-weight="1000" fill="#111" style="font-family: 'Press Start 2P', system-ui, sans-serif;">PROVA A</text>
            <text x="84" y="56" text-anchor="middle" font-size="14" font-weight="1000" fill="#111" style="font-family: 'Press Start 2P', system-ui, sans-serif;">PRENDERMI</text>
          </g>
        </g>

        <!-- Old smoker: Pac-man ghost w/ cigarette -->
        <g id="oldGhost">
          <use href="#ghostBody" fill="rgba(220,220,230,.95)"/>
          <g transform="translate(12 22)">
            <ellipse cx="18" cy="18" rx="12" ry="14" fill="#FFF"/>
            <ellipse cx="42" cy="18" rx="12" ry="14" fill="#FFF"/>
            <circle cx="20" cy="20" r="5" fill="#2E7DFF"/>
            <circle cx="44" cy="20" r="5" fill="#2E7DFF"/>
          </g>
          <!-- torn clothes vibes -->
          <path d="M8 62 L18 54 L28 66 L40 54 L52 68 L62 56 L70 66" stroke="rgba(0,0,0,.18)" stroke-width="4" fill="none" stroke-linecap="round"/>
          <!-- cigarette -->
          <g transform="translate(58 40)">
            <rect x="0" y="10" width="22" height="6" rx="3" fill="#F2F2F2"/>
            <rect x="18" y="10" width="6" height="6" rx="3" fill="#FF2E2E"/>
            <path d="M22 6 C 28 2 32 -6 26 -12" fill="none" stroke="rgba(255,255,255,.45)" stroke-width="3" stroke-linecap="round"/>
          </g>
        </g>

        <!-- Baguette -->
        <g id="baguetteDef">
          <g transform="rotate(-8 45 13)">
            <rect x="0" y="0" width="90" height="26" rx="13" fill="#E7C178"/>
            <path d="M16 8 L24 18 M34 8 L42 18 M52 8 L60 18 M70 8 L78 18"
                  stroke="rgba(120,70,20,.35)" stroke-width="4" stroke-linecap="round"/>
          </g>
        </g>
      </defs>

      <!-- BACKGROUND -->
      <g id="bg">
        <rect x="0" y="0" width="1000" height="600" fill="#05060B"/>
        <g id="maze" filter="url(#mazeGlow)" opacity="0.95">
          <!-- Outer frame -->
          <rect x="48" y="56" width="904" height="496" rx="24" fill="none" stroke="var(--maze)" stroke-width="10"/>
          <!-- Classic-ish pac maze segments (decor only) -->
          <path d="M120 120 H 420 V 180 H 260 V 240 H 460 V 120"
                fill="none" stroke="var(--maze)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M540 120 H 880 V 240 H 740 V 180 H 580 V 240 H 540 V 120"
                fill="none" stroke="var(--maze)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M160 300 H 360 V 360 H 220 V 440 H 160 V 300"
                fill="none" stroke="var(--maze)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M640 300 H 840 V 440 H 780 V 360 H 640 V 300"
                fill="none" stroke="var(--maze)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M420 320 H 580 V 420 H 420 Z"
                fill="none" stroke="var(--maze)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
        </g>

        <!-- Pellets (decor only) -->
        <g id="pellets" opacity="0.75"></g>
      </g>

      <!-- TITLE LAYER -->
      <g id="titleLayer">
        <g filter="url(#mazeGlow)" opacity="0.92">
          <text x="500" y="105" text-anchor="middle" fill="#FFFFFF"
                style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:26px;">
            5 YEARS: SURVIVAL
          </text>
          <text x="500" y="150" text-anchor="middle" fill="rgba(255,255,255,.92)"
                style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:20px;">
            ANNIVERSARY MODE
          </text>
        </g>

        <!-- demo sprites on title -->
        <g filter="url(#softShadow)">
          <g transform="translate(220 300) scale(1.0)">
            <use href="#ettorePac"/>
          </g>
          <g transform="translate(740 300) scale(1.0)">
            <use href="#patryPac"/>
          </g>
          <g transform="translate(420 350) scale(1.0)">
            <use href="#oldGhost"/>
          </g>
          <g transform="translate(520 260) scale(1.0)">
            <use href="#baguetteDef"/>
          </g>
        </g>

        <g id="pressStart" class="blink clickable" text-anchor="middle" filter="url(#mazeGlow)">
          <text x="500" y="525" fill="var(--yellow)"
                style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:18px;">PRESS START</text>
        </g>

        <g id="startButton" class="clickable pulse" filter="url(#softShadow)">
          <rect x="340" y="420" width="320" height="82" rx="18"
                fill="rgba(46,125,255,.18)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
          <text x="500" y="472" text-anchor="middle" fill="rgba(255,255,255,.92)"
                style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:20px;">START</text>
        </g>

        <style>
          .blink{ animation: blink 0.38s steps(2,end) infinite; }
          .pulse{ animation: pulse 1.25s ease-in-out infinite; transform-origin: 500px 461px; }
          .clickable{ cursor:pointer; pointer-events: all; }
          @keyframes pulse { 0%,100%{ transform: scale(1) } 50%{ transform: scale(1.03) } }
        </style>
      </g>

      <!-- CHASE LAYER -->
      <g id="chaseLayer" opacity="0">
        <g id="olds"></g>
        <g id="baguettes"></g>

        <g id="patry" filter="url(#softShadow)"></g>
        <g id="ettore" filter="url(#softShadow)"></g>

        <line id="targetLine" x1="0" y1="0" x2="0" y2="0"
              stroke="rgba(255,216,77,.14)" stroke-width="3" stroke-linecap="round"/>
      </g>

      <!-- QUIZ BACKGROUND LAYER (kept simple pac-style) -->
      <g id="quizBgLayer" opacity="0">
        <rect x="0" y="0" width="1000" height="600" fill="#05060B"/>
        <g filter="url(#mazeGlow)" opacity="0.85">
          <rect x="90" y="90" width="820" height="420" rx="22" fill="none" stroke="var(--maze)" stroke-width="10"/>
        </g>
        <g opacity="0.18">
          <g transform="translate(140 150) scale(0.9)"><use href="#oldGhost"/></g>
          <g transform="translate(760 420) scale(0.9)"><use href="#oldGhost"/></g>
          <g transform="translate(720 150) scale(0.9)"><use href="#baguetteDef"/></g>
        </g>
      </g>

      <!-- GIFT LAYER -->
      <g id="giftLayer" opacity="0">
        <rect x="0" y="0" width="1000" height="600" fill="#05060B"/>
        <g filter="url(#mazeGlow)" opacity="0.95">
          <rect x="70" y="70" width="860" height="460" rx="22" fill="none" stroke="var(--maze)" stroke-width="10"/>
        </g>

        <text x="500" y="120" text-anchor="middle" fill="#FFFFFF"
              style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:18px;">
          YOU WIN!
        </text>

        <g id="giftBox" filter="url(#softShadow)" transform="translate(420 260)" style="cursor:pointer">
          <rect x="0" y="36" width="160" height="120" rx="16" fill="rgba(255,77,160,.60)" stroke="rgba(255,255,255,.18)"/>
          <rect x="72" y="36" width="16" height="120" rx="8" fill="rgba(46,125,255,.70)"/>
          <rect x="0" y="88" width="160" height="16" rx="8" fill="rgba(46,125,255,.70)"/>
          <g id="giftLid">
            <rect x="-6" y="0" width="172" height="42" rx="16" fill="rgba(255,77,160,.75)" stroke="rgba(255,255,255,.18)"/>
            <text x="80" y="28" text-anchor="middle" fill="rgba(255,255,255,.90)"
                  style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:12px;">CLICK!</text>
          </g>
        </g>

        <g id="parchment" opacity="0" filter="url(#softShadow)">
          <rect x="120" y="160" width="760" height="260" rx="18" fill="rgba(247,242,232,.96)" stroke="rgba(0,0,0,.18)"/>
          <text x="500" y="198" text-anchor="middle" fill="#1A1A1A"
                style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:14px;">CERTIFICATO</text>

          <g text-anchor="middle" fill="#1A1A1A" style="font-family: Inter, system-ui, sans-serif; font-weight: 900; font-size: 16px;">
            <text x="500" y="236">Certificato di sopravvivenza quinquennale</text>
            <text x="500" y="262">conferito a</text>
            <text x="500" y="295" style="font-size:20px;">ETTORE GORNI,</text>
            <text x="500" y="326">in qualit√† di moroso pi√π paziente</text>
            <text x="500" y="352">e bubo pi√π adorabile che ci sia.</text>
          </g>
        </g>

        <g id="kissScene" opacity="0">
          <g id="ettoreK" transform="translate(260 440) scale(0.9)"><use href="#ettorePac"/></g>
          <g id="patryK"  transform="translate(660 440) scale(0.9)"><use href="#patryPac"/></g>

          <g id="bigHeart" opacity="0" transform="translate(500 455) scale(2.0)">
            <path d="M0 -16 C0 -30 -18 -34 -28 -22 C-38 -10 -30 6 0 24 C30 6 38 -10 28 -22 C18 -34 0 -30 0 -16 Z"
                  fill="rgba(255,46,46,.88)" filter="url(#softShadow)"/>
          </g>

          <text id="tbc" x="500" y="560" text-anchor="middle" fill="rgba(255,255,255,.92)" opacity="0"
                style="font-family:'Press Start 2P',system-ui,sans-serif; font-size:16px;">
            TO BE CONTINUED...
          </text>
        </g>
      </g>
    </svg>

    <!-- UI overlay -->
    <div class="ui">
      <div class="topbar">
        <div class="pill">üéÆ <span>CHASE</span> <small>evita üë¥üö¨ & ü•ñ</small></div>
        <div class="pill">Obiettivo: <span style="color:var(--yellow); font-weight:1000;">raggiungi Patry</span></div>
      </div>

      <div id="toast" class="toast"></div>

      <div class="titleCard">
        <div class="left">
          <div class="hint"><b>PC:</b> WASD / frecce ‚Ä¢ <b>Mobile:</b> pad in basso</div>
          <div class="hint">Stile <b>Pac-Man</b>: solo <b>vecchi</b> e <b>baguette</b> ti fermano. Se ti prendono: <b>TRY AGAIN</b>.</div>
        </div>
        <div class="btnRow">
          <button id="startBtn" type="button">START</button>
          <button id="muteBtn" type="button" class="secondary">Audio: ON</button>
        </div>
      </div>

      <div class="controls">
        <div class="dpad">
          <div class="pad padGhost"></div>
          <div class="pad" data-dir="up">‚ñ≤</div>
          <div class="pad padGhost"></div>
          <div class="pad" data-dir="left">‚óÄ</div>
          <div class="pad" data-dir="down">‚ñº</div>
          <div class="pad" data-dir="right">‚ñ∂</div>
          <div class="pad padGhost"></div>
          <div class="pad padGhost"></div>
          <div class="pad padGhost"></div>
        </div>
        <div class="sideHint"><b>TIP:</b> muoviti sempre ‚Äî i vecchi ti inseguono üë¥üö¨</div>
      </div>

      <div id="centerOverlay">
        <div id="centerText" class="centerText">
          <div id="centerBig" class="big blink90">TRY AGAIN</div>
          <div id="centerSub" class="sub">Clicca per ricominciare</div>
        </div>
      </div>

      <div id="quiz">
        <div class="quizCard">
          <div class="quizHead">
            <h2 id="qtitle">QUIZ A TEMPO ‚Äî 10s</h2>
            <div class="meta">Domanda <span id="qindex">1</span>/5 ‚Ä¢ ‚è± <span id="tleft">10</span>s</div>
          </div>
          <div class="qtext" id="qtext"></div>
          <div class="options" id="options"></div>
          <div class="bar">
            <div class="meter"><div class="fill" id="tfill"></div></div>
            <div id="retry">
              <p class="msg" id="retryMsg"></p>
              <button id="retryBtn" type="button">Ritenta il quiz</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  const body = document.body;
  const svg = document.getElementById('svg');

  // Fit viewBox
  function fitViewBox(){
    const baseW = 1000, baseH = 600;
    const baseAR = baseW / baseH;
    const vw = (window.visualViewport && window.visualViewport.width)  ? window.visualViewport.width  : window.innerWidth;
    const vh = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
    const screenAR = vw / vh;

    let vbX = 0, vbY = 0, vbW = baseW, vbH = baseH;
    if(screenAR < baseAR){
      vbH = baseW / screenAR;
      vbY = (baseH - vbH) / 2;
    } else {
      vbW = baseH * screenAR;
      vbX = (baseW - vbW) / 2;
    }
    svg.setAttribute('viewBox', `${vbX} ${vbY} ${vbW} ${vbH}`);
  }
  fitViewBox();
  window.addEventListener('resize', () => requestAnimationFrame(fitViewBox));
  window.addEventListener('orientationchange', () => setTimeout(fitViewBox, 150));
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', () => requestAnimationFrame(fitViewBox));
  }

  // DOM layers
  const titleLayer = document.getElementById('titleLayer');
  const chaseLayer = document.getElementById('chaseLayer');
  const quizBgLayer = document.getElementById('quizBgLayer');
  const giftLayer = document.getElementById('giftLayer');

  const pelletsG = document.getElementById('pellets');
  const oldsG = document.getElementById('olds');
  const baguettesG = document.getElementById('baguettes');

  const ettoreG = document.getElementById('ettore');
  const patryG = document.getElementById('patry');
  const targetLine = document.getElementById('targetLine');

  const pressStart = document.getElementById('pressStart');
  const startButton = document.getElementById('startButton');
  const startBtn = document.getElementById('startBtn');
  const muteBtn = document.getElementById('muteBtn');
  const toast = document.getElementById('toast');

  // Overlay
  const centerOverlay = document.getElementById('centerOverlay');
  const centerBig = document.getElementById('centerBig');
  const centerSub = document.getElementById('centerSub');

  // Quiz UI
  const qtitle = document.getElementById('qtitle');
  const qindexEl = document.getElementById('qindex');
  const qtextEl = document.getElementById('qtext');
  const optionsEl = document.getElementById('options');
  const tleftEl = document.getElementById('tleft');
  const tfillEl = document.getElementById('tfill');
  const retryBox = document.getElementById('retry');
  const retryMsg = document.getElementById('retryMsg');
  const retryBtn = document.getElementById('retryBtn');

  // Gift
  const giftBox = document.getElementById('giftBox');
  const giftLid = document.getElementById('giftLid');
  const parchment = document.getElementById('parchment');
  const kissScene = document.getElementById('kissScene');
  const ettoreK = document.getElementById('ettoreK');
  const patryK = document.getElementById('patryK');
  const bigHeart = document.getElementById('bigHeart');
  const tbc = document.getElementById('tbc');

  // Helpers
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const rand = (a,b) => a + Math.random()*(b-a);
  const pick = (arr) => arr[(Math.random()*arr.length)|0];
  const now = () => performance.now();

  const NS = "http://www.w3.org/2000/svg";

  function setOpacity(el, v){ el.setAttribute('opacity', String(v)); }
  function setTransform(el, x, y, s=1, rot=0){
    el.setAttribute('transform', `translate(${x} ${y}) scale(${s}) rotate(${rot} 48 48)`);
  }
  function rectsOverlap(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  // Audio
  let audioOn = true;
  let audioCtx = null;
  function beep(freq=440, dur=0.08, type='square', gain=0.03){
    if(!audioOn) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + dur);
    }catch(_){}
  }
  function ensureAudio(){ if(audioOn && !audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(_){}} }

  // Toast
  let toastTimer = 0;
  function showToast(msg, ms=1400){
    toast.textContent = msg;
    toast.classList.add('show');
    toastTimer = ms;
  }

  // State
  const State = { TITLE:'title', CHASE:'chase', QUIZ:'quiz', GIFT:'gift' };
  let state = State.TITLE;

  function setState(s){
    state = s;
    body.classList.remove('state-title','state-chase','state-quiz','state-gift');
    body.classList.add(`state-${s}`);

    if(s === State.TITLE){
      setOpacity(titleLayer, 1); setOpacity(chaseLayer, 0); setOpacity(quizBgLayer, 0); setOpacity(giftLayer, 0);
    }else if(s === State.CHASE){
      setOpacity(titleLayer, 0); setOpacity(chaseLayer, 1); setOpacity(quizBgLayer, 0); setOpacity(giftLayer, 0);
    }else if(s === State.QUIZ){
      setOpacity(titleLayer, 0); setOpacity(chaseLayer, 0); setOpacity(quizBgLayer, 1); setOpacity(giftLayer, 0);
    }else if(s === State.GIFT){
      setOpacity(titleLayer, 0); setOpacity(chaseLayer, 0); setOpacity(quizBgLayer, 0); setOpacity(giftLayer, 1);
    }
  }

  // Pellets decor
  function buildPellets(){
    pelletsG.innerHTML = '';
    const cols = 32, rows = 18;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        if((r+c)%2!==0) continue;
        const x = 70 + c*(860/(cols-1));
        const y = 90 + r*(440/(rows-1));
        // don't spam the center too much
        if(x>420 && x<580 && y>240 && y<360) continue;

        const dot = document.createElementNS(NS,'circle');
        dot.setAttribute('cx', x);
        dot.setAttribute('cy', y);
        dot.setAttribute('r', (Math.random()<0.06) ? 6 : 3.2);
        dot.setAttribute('fill', 'rgba(255,216,77,.95)');
        dot.setAttribute('opacity', (Math.random()<0.06) ? '0.9' : '0.55');
        pelletsG.appendChild(dot);
      }
    }
  }
  buildPellets();

  // -------------------------------
  // CHASE: only olds + baguettes as obstacles
  // -------------------------------
  const SCALE = 0.70;             // sprite scale in chase (Pac sprites are compact)
  const player = { x: 120, y: 500, w: 70, h: 70, speed: 700 };
  const girl   = { x: 860, y: 95,  w: 70, h: 70 };

  let olds = [];
  let baguettes = [];
  let baguetteSpawn = 0;

  // movement direction for rotation + mouth
  let lastDir = 'right';
  let moving = false;
  let mouthPhase = 0;

  function makeUse(href){
    const g = document.createElementNS(NS,'g');
    const u = document.createElementNS(NS,'use');
    u.setAttribute('href', href);
    g.appendChild(u);
    return g;
  }

  function buildChaseSprites(){
    ettoreG.innerHTML = '';
    patryG.innerHTML = '';
    ettoreG.appendChild(makeUse('#ettorePac'));
    patryG.appendChild(makeUse('#patryPac'));
  }
  buildChaseSprites();

  function spawnOlds(){
    oldsG.innerHTML = '';
    olds = [];
    const spawns = [
      {x: 250, y: 140},
      {x: 700, y: 160},
      {x: 420, y: 360},
      {x: 820, y: 420},
      {x: 160, y: 420},
    ];
    for(let i=0;i<spawns.length;i++){
      const el = makeUse('#oldGhost');
      el.setAttribute('filter','url(#softShadow)');
      oldsG.appendChild(el);
      olds.push({
        id: i,
        x: spawns[i].x,
        y: spawns[i].y,
        w: 72, h: 78,
        speed: rand(95, 135),
        wob: rand(0, 10),
        el
      });
      // old ghost uses 72x78-ish view; we place it with scale
      el.setAttribute('transform', `translate(${spawns[i].x} ${spawns[i].y}) scale(${0.95})`);
    }
  }

  function spawnBaguette(){
    const el = makeUse('#baguetteDef');
    el.setAttribute('filter','url(#softShadow)');
    baguettesG.appendChild(el);

    // spawn from random edge for a more Pac chaos
    const side = (Math.random()*4)|0;
    let x, y, vx, vy;
    const speed = rand(520, 720);
    if(side===0){ x=-120; y=rand(90,530); vx=speed; vy=rand(-70,70); }
    else if(side===1){ x=1120; y=rand(90,530); vx=-speed; vy=rand(-70,70); }
    else if(side===2){ x=rand(60,940); y=-80; vx=rand(-80,80); vy=speed; }
    else { x=rand(60,940); y=680; vx=rand(-80,80); vy=-speed; }

    baguettes.push({
      x, y, w: 90, h: 26,
      vx, vy,
      wob: rand(0,10),
      el
    });
  }

  function resetChase(){
    player.x = 120; player.y = 500;
    girl.x = 860; girl.y = 95;

    baguettes = [];
    baguettesG.innerHTML = '';
    baguetteSpawn = 0.30;

    lastDir = 'right';
    moving = false;
    mouthPhase = 0;

    spawnOlds();
    // render initial positions
    setTransform(ettoreG, player.x, player.y, SCALE, 0);
    setTransform(patryG, girl.x, girl.y, SCALE, 0);
  }

  // Input
  const keys = {up:false,down:false,left:false,right:false};
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(k) || k===' '){
      e.preventDefault();
    }
    if(k==='arrowup' || k==='w') keys.up=true;
    if(k==='arrowdown'|| k==='s') keys.down=true;
    if(k==='arrowleft'|| k==='a') keys.left=true;
    if(k==='arrowright'|| k==='d') keys.right=true;
  }, {passive:false});
  window.addEventListener('keyup', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='arrowup' || k==='w') keys.up=false;
    if(k==='arrowdown'|| k==='s') keys.down=false;
    if(k==='arrowleft'|| k==='a') keys.left=false;
    if(k==='arrowright'|| k==='d') keys.right=false;
  });

  const activeDirs = new Set();
  document.querySelectorAll('.pad').forEach(btn=>{
    const dir = btn.dataset.dir;
    if(!dir) return;
    const on = (e)=>{ e.preventDefault(); activeDirs.add(dir); syncDirs(); };
    const off = (e)=>{ e.preventDefault(); activeDirs.delete(dir); syncDirs(); };
    btn.addEventListener('pointerdown', on, {passive:false});
    btn.addEventListener('pointerup', off, {passive:false});
    btn.addEventListener('pointercancel', off, {passive:false});
    btn.addEventListener('pointerleave', off, {passive:false});
  });
  function syncDirs(){
    keys.up = activeDirs.has('up');
    keys.down = activeDirs.has('down');
    keys.left = activeDirs.has('left');
    keys.right = activeDirs.has('right');
  }

  // Overlay control
  let overlayMode = 'none'; // none | try | win
  let winTimer = 0;

  function showTryAgain(){
    overlayMode = 'try';
    centerBig.textContent = 'TRY AGAIN';
    centerSub.textContent = 'Clicca per ricominciare';
    centerOverlay.classList.add('show');
    beep(150, .12, 'square', .06);
  }
  function showFinallyTogether(){
    overlayMode = 'win';
    centerBig.textContent = 'FINALLY TOGETHER!';
    centerSub.textContent = '‚Ä¶e ora il quiz!';
    centerOverlay.classList.add('show');
    beep(880, .10, 'triangle', .06);
    winTimer = 0.9;
  }
  function hideOverlay(){
    overlayMode = 'none';
    centerOverlay.classList.remove('show');
  }

  centerOverlay.addEventListener('click', (e)=>{
    e.preventDefault();
    if(overlayMode === 'try'){
      hideOverlay();
      resetChase();
      setState(State.CHASE);
      showToast("INSERT COIN‚Ä¶ scherzo üòÑ GO!", 950);
    }
  });

  // Title start
  function startGame(){
    if(state !== State.TITLE) return;
    ensureAudio();
    hideOverlay();
    resetChase();
    setState(State.CHASE);
    showToast("CHASE MODE: raggiungi Patry! üíñ", 1200);
    beep(520, .07, 'triangle', .04);
  }
  startBtn.addEventListener('click', (e)=>{ e.preventDefault(); startGame(); });
  pressStart.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startGame(); }, {passive:false});
  startButton.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startGame(); }, {passive:false});
  window.addEventListener('keydown', (e)=>{
    if(state !== State.TITLE) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      startGame();
    }
  }, {passive:false});

  muteBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    audioOn = !audioOn;
    muteBtn.textContent = `Audio: ${audioOn ? 'ON' : 'OFF'}`;
    beep(audioOn ? 600 : 200, .06, 'triangle', .03);
  });

  // Mouth animation: toggle open/closed paths by opacity
  function updateMouth(){
    const mouthOpen = ettoreG.querySelector('#mouthOpen');
    const mouthClosed = ettoreG.querySelector('#mouthClosed');
    if(!mouthOpen || !mouthClosed) return;
    if(!moving){
      mouthOpen.setAttribute('opacity','0.30');
      mouthClosed.setAttribute('opacity','0');
      return;
    }
    const t = mouthPhase % 1.0;
    const open = t < 0.5;
    mouthOpen.setAttribute('opacity', open ? '0.92' : '0.18');
    mouthClosed.setAttribute('opacity', open ? '0' : '0.92');
  }

  function dirToRot(d){
    if(d==='right') return 0;
    if(d==='down') return 90;
    if(d==='left') return 180;
    if(d==='up') return -90;
    return 0;
  }

  // -------------------------------
  // QUIZ
  // -------------------------------
  const wrongMessages = [
    "‚ùå NOPE. Per farti perdonare: offrire il sushi. Ora ritenta il quiz!",
    "‚ùå SBAGLIATO. Punizione: pulire i piatti per un mese senza lamentarsi. Ritenta!",
    "‚ùå AHI. Ti tocca: comprare una pianta grandissima da mettere in soggiorno (e curarla!). Ritenta!"
  ];

  const questions = [
    { q:"Il posto del primo date?", opts:["Casa del popolo","Carmentown","Bar dell'ombra"], correct:1 },
    { q:"Cosa fa Patry quando √® scocciata da qualcosa?", opts:["Sbuffino","Agita i pugni in aria","Fa bibi"], correct:0 },
    { q:"La volta in cui ho rischiato molto di non festeggiare questo anniversario?", opts:[
      "Quando siamo rimasti quasi bloccati per due giorni con la macchina nel parcheggio di Almacube",
      "Quando non ho prenotato l'albergo in Grecia",
      "Quando mi sono addormentato alla guida facendoci quasi uscire dalla strada"
    ], correct:0 },
    { q:"Qual √® il dessert coccola che ci regaliamo quando siamo gi√π?", opts:["San Salvatore","Pudding di chia","Gelato d'Azeglio"], correct:0 },
    { q:"Il nomignolo pi√π usato per chiamarci?", opts:["Bubo/a","Cucci","Tesoro"], correct:0 },
  ];

  let qIndex = 0;
  let qTime = 10.0;
  let qRunning = false;

  function updateQuizMeter(){
    tleftEl.textContent = Math.ceil(qTime).toString();
    const ratio = clamp(qTime/10, 0, 1);
    tfillEl.style.transform = `scaleX(${ratio})`;
    tleftEl.classList.toggle('danger', qTime <= 3.2);
  }

  function setupQuestion(){
    const item = questions[qIndex];
    qtitle.textContent = "QUIZ A TEMPO ‚Äî 10s";
    qindexEl.textContent = (qIndex+1).toString();
    qtextEl.textContent = item.q;

    optionsEl.innerHTML = '';
    item.opts.forEach((txt, idx)=>{
      const b = document.createElement('button');
      b.className = 'opt';
      b.type = 'button';
      b.textContent = txt;
      b.addEventListener('click', ()=>answer(idx));
      optionsEl.appendChild(b);
    });

    qTime = 10.0;
    updateQuizMeter();
  }

  function failQuiz(){
    qRunning = false;
    retryMsg.textContent = pick(wrongMessages);
    retryBox.style.display = 'block';
    beep(180, .14, 'square', .06);
  }

  function answer(idx){
    if(!qRunning) return;
    const item = questions[qIndex];
    if(idx === item.correct){
      beep(860, .08, 'triangle', .05);
      qIndex++;
      if(qIndex >= questions.length){
        qRunning = false;
        enterGift();
      }else{
        setupQuestion();
      }
    }else{
      failQuiz();
    }
  }

  retryBtn.addEventListener('click', ()=>{
    qIndex = 0;
    retryBox.style.display = 'none';
    setupQuestion();
    qRunning = true;
    beep(520, .07, 'triangle', .04);
  });

  function enterQuiz(){
    setState(State.QUIZ);
    qIndex = 0;
    retryBox.style.display = 'none';
    setupQuestion();
    qRunning = true;
    showToast("QUIZ MODE: 10s per domanda ‚è±", 1200);
    beep(660, .08, 'triangle', .04);
  }

  // -------------------------------
  // Gift flow
  // -------------------------------
  let giftOpened = false;

  function enterGift(){
    setState(State.GIFT);
    giftOpened = false;
    parchment.setAttribute('opacity','0');
    kissScene.setAttribute('opacity','0');
    bigHeart.setAttribute('opacity','0');
    tbc.setAttribute('opacity','0');
    giftLid.setAttribute('transform','translate(0 0)');
    showToast("üéÅ Premi sul pacchetto!", 1500);
    beep(740, .08, 'triangle', .04);
  }

  function openGift(){
    if(giftOpened) return;
    giftOpened = true;

    // lid pop
    giftLid.setAttribute('transform','translate(0 -18) rotate(-8 80 20)');
    beep(920, .06, 'triangle', .05);

    // parchment in
    setTimeout(()=> {
      parchment.setAttribute('opacity','1');
      beep(520, .07, 'triangle', .04);
    }, 250);

    // kiss scene
    setTimeout(()=> {
      kissScene.setAttribute('opacity','1');
      // move sprites together
      let t = 0;
      const a0 = {x:260, y:440};
      const b0 = {x:660, y:440};
      const a1 = {x:410, y:440};
      const b1 = {x:510, y:440};
      const step = () => {
        t += 0.04;
        const u = Math.min(1, t);
        const ax = a0.x + (a1.x - a0.x)*u;
        const bx = b0.x + (b1.x - b0.x)*u;
        ettoreK.setAttribute('transform', `translate(${ax} ${a0.y}) scale(0.9)`);
        patryK.setAttribute('transform', `translate(${bx} ${b0.y}) scale(0.9)`);
        if(u < 1) requestAnimationFrame(step);
        else{
          bigHeart.setAttribute('opacity','1');
          tbc.setAttribute('opacity','1');
          beep(1040, .10, 'triangle', .05);
        }
      };
      requestAnimationFrame(step);
    }, 800);
  }

  giftBox.addEventListener('click', (e)=>{ e.preventDefault(); openGift(); });

  // -------------------------------
  // Main loop
  // -------------------------------
  let last = now();
  let tGlobal = 0;

  function update(dt){
    // toast
    if(toastTimer > 0){
      toastTimer -= dt*1000;
      if(toastTimer <= 0) toast.classList.remove('show');
    }

    // overlay timing for win -> quiz
    if(overlayMode === 'win'){
      winTimer -= dt;
      if(winTimer <= 0){
        hideOverlay();
        enterQuiz();
      }
      return;
    }
    if(overlayMode === 'try'){
      return;
    }

    if(state === State.CHASE){
      // movement
      let dx=0, dy=0;
      const sp = player.speed;

      if(keys.left)  dx -= sp*dt;
      if(keys.right) dx += sp*dt;
      if(keys.up)    dy -= sp*dt;
      if(keys.down)  dy += sp*dt;

      moving = !!(dx || dy);
      if(dx && dy){ dx*=0.7071; dy*=0.7071; }

      // decide direction
      if(Math.abs(dx) > Math.abs(dy)){
        if(dx > 0) lastDir = 'right';
        if(dx < 0) lastDir = 'left';
      }else if(Math.abs(dy) > 0){
        if(dy > 0) lastDir = 'down';
        if(dy < 0) lastDir = 'up';
      }

      player.x += dx;
      player.y += dy;

      // bounds (maze is decorative; ONLY olds & baguettes are obstacles)
      player.x = clamp(player.x, 60, 940);
      player.y = clamp(player.y, 80, 520);

      // mouth animation
      if(moving) mouthPhase = (mouthPhase + dt*3.2) % 1.0;
      updateMouth();

      // old chase
      const pCx = player.x + player.w/2;
      const pCy = player.y + player.h/2;

      for(const o of olds){
        o.wob += dt * 3.6;
        const oCx = o.x + o.w/2;
        const oCy = o.y + o.h/2;
        let vx = (pCx - oCx);
        let vy = (pCy - oCy);
        const len = Math.hypot(vx,vy) || 1;
        vx /= len; vy /= len;

        // wobble
        vx += Math.sin(o.wob)*0.10;
        vy += Math.cos(o.wob*1.05)*0.08;

        const step = o.speed * dt;
        o.x += vx * step;
        o.y += vy * step;

        o.x = clamp(o.x, 60, 940);
        o.y = clamp(o.y, 80, 520);

        // rotate ghost eyes a bit toward player
        const rot = (vx >= 0) ? 0 : 0;
        o.el.setAttribute('transform', `translate(${o.x} ${o.y}) scale(0.95) rotate(${rot} 36 36)`);

        // collision -> try again
        if(rectsOverlap(player, o)){
          showTryAgain();
          return;
        }
      }

      // baguettes spawn
      baguetteSpawn -= dt;
      if(baguetteSpawn <= 0){
        baguetteSpawn = rand(0.65, 1.05);
        spawnBaguette();
      }

      // baguettes update
      for(const bq of baguettes){
        bq.wob += dt*6.0;
        bq.x += bq.vx*dt;
        bq.y += bq.vy*dt + Math.sin(bq.wob)*18*dt;
        bq.el.setAttribute('transform', `translate(${bq.x} ${bq.y}) rotate(${Math.sin(bq.wob)*8} 45 13)`);
      }

      // remove offscreen
      baguettes = baguettes.filter(bq=>{
        if(bq.x < -220 || bq.x > 1220 || bq.y < -220 || bq.y > 820){
          bq.el.remove();
          return false;
        }
        return true;
      });

      // baguette collision -> try again
      for(const bq of baguettes){
        const bBox = {x:bq.x, y:bq.y, w:bq.w, h:bq.h};
        if(rectsOverlap(player, bBox)){
          showTryAgain();
          return;
        }
      }

      // render characters
      const rot = dirToRot(lastDir);
      setTransform(ettoreG, player.x, player.y, SCALE, rot);
      setTransform(patryG, girl.x, girl.y, SCALE, 0);

      // target line (subtle)
      const px = player.x + player.w/2, py = player.y + player.h/2;
      const gx = girl.x + girl.w/2, gy = girl.y + girl.h/2;
      targetLine.setAttribute('x1', px);
      targetLine.setAttribute('y1', py);
      targetLine.setAttribute('x2', gx);
      targetLine.setAttribute('y2', gy);

      // win
      const gBox = {x:girl.x, y:girl.y, w:girl.w, h:girl.h};
      if(rectsOverlap(player, gBox)){
        showFinallyTogether();
        return;
      }
    }

    if(state === State.QUIZ){
      if(qRunning){
        qTime -= dt;
        if(qTime <= 0){
          qTime = 0;
          updateQuizMeter();
          failQuiz();
        }else{
          updateQuizMeter();
        }
      }
    }
  }

  function dirToRot(d){
    if(d==='right') return 0;
    if(d==='down') return 90;
    if(d==='left') return 180;
    if(d==='up') return -90;
    return 0;
  }

  function frame(){
    const n = now();
    const dt = Math.min(0.06, (n-last)/1000);
    last = n;
    tGlobal = n;
    update(dt);
    requestAnimationFrame(frame);
  }

  // Init
  setState(State.TITLE);
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
